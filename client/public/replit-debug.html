<!DOCTYPE html>
<html>
<head>
  <title>Replit Connection Debug</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
    .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
  </style>
</head>
<body>
  <h1>🔍 Replit Connection Diagnostic</h1>
  <div id="results"></div>

  <script>
    const results = document.getElementById('results');
    
    function addResult(message, type = 'info') {
      const div = document.createElement('div');
      div.className = `status ${type}`;
      div.innerHTML = message;
      results.appendChild(div);
    }

    // 1. Environment Detection
    addResult(`<strong>🌍 Environment:</strong><br>
      - URL: ${window.location.href}<br>
      - Hostname: ${window.location.hostname}<br>
      - Is iframe: ${window.self !== window.top}<br>
      - User Agent: ${navigator.userAgent}`, 'info');

    // 2. Replit Domain Check
    const isReplit = window.location.hostname.includes('replit.dev');
    addResult(`<strong>🏠 Replit Domain:</strong> ${isReplit ? '✅ Yes' : '❌ No'}`, 
              isReplit ? 'success' : 'error');

    // 3. API Health Check
    async function checkAPI() {
      try {
        const response = await fetch('/api/auth/user');
        addResult(`<strong>🔗 API Connection:</strong> ✅ Status ${response.status}`, 'success');
      } catch (error) {
        addResult(`<strong>🔗 API Connection:</strong> ❌ ${error.message}`, 'error');
      }
    }

    // 4. WebSocket Test
    function testWebSocket() {
      try {
        const wsUrl = `wss://${window.location.hostname}`;
        const ws = new WebSocket(wsUrl);
        ws.onopen = () => {
          addResult(`<strong>🔌 WebSocket:</strong> ✅ Connected to ${wsUrl}`, 'success');
          ws.close();
        };
        ws.onerror = (error) => {
          addResult(`<strong>🔌 WebSocket:</strong> ❌ Failed to connect`, 'error');
        };
      } catch (error) {
        addResult(`<strong>🔌 WebSocket:</strong> ❌ ${error.message}`, 'error');
      }
    }

    // 5. CSP Headers Check
    async function checkCSP() {
      try {
        const response = await fetch('/', { method: 'HEAD' });
        const csp = response.headers.get('Content-Security-Policy');
        addResult(`<strong>🛡️ CSP Headers:</strong><br><pre style="font-size:12px">${csp || 'None'}</pre>`, 
                  csp ? 'success' : 'error');
      } catch (error) {
        addResult(`<strong>🛡️ CSP Headers:</strong> ❌ Cannot check headers`, 'error');
      }
    }

    // Run all tests
    addResult('<strong>🚀 Running diagnostics...</strong>', 'info');
    checkAPI();
    testWebSocket();
    checkCSP();
  </script>
</body>
</html>